"use strict";(self.webpackChunkjiangmiemie=self.webpackChunkjiangmiemie||[]).push([[5458],{28861:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var a=t(74848),s=t(28453);const i={title:"\u4f7f\u7528flask\u642d\u5efa\u4e2a\u4eba\u5171\u4eab\u5c4f\u5e55\u5de5\u5177",date:"2024-5-31",authors:"jiangmiemie",tags:["smarthome"],keywords:["smarthome"],description:"\u8bb0\u5f55\u4f7f\u7528flask\u642d\u5efa\u4e2a\u4eba\u5171\u4eab\u5c4f\u5e55\u5de5\u5177"},r=void 0,o={permalink:"/blog/2024/5/31/",source:"@site/blog/2024-5-31.md",title:"\u4f7f\u7528flask\u642d\u5efa\u4e2a\u4eba\u5171\u4eab\u5c4f\u5e55\u5de5\u5177",description:"\u8bb0\u5f55\u4f7f\u7528flask\u642d\u5efa\u4e2a\u4eba\u5171\u4eab\u5c4f\u5e55\u5de5\u5177",date:"2024-05-31T00:00:00.000Z",tags:[{inline:!0,label:"smarthome",permalink:"/blog/tags/smarthome"}],readingTime:4.515,hasTruncateMarker:!1,authors:[{name:"Allen",title:"software engineer",url:"https://github.com/jiangyangcreate",imageURL:"https://jiangmiemie.com/img/logo-192.svg",key:"jiangmiemie"}],frontMatter:{title:"\u4f7f\u7528flask\u642d\u5efa\u4e2a\u4eba\u5171\u4eab\u5c4f\u5e55\u5de5\u5177",date:"2024-5-31",authors:"jiangmiemie",tags:["smarthome"],keywords:["smarthome"],description:"\u8bb0\u5f55\u4f7f\u7528flask\u642d\u5efa\u4e2a\u4eba\u5171\u4eab\u5c4f\u5e55\u5de5\u5177"},unlisted:!1,prevItem:{title:"\u84dd\u7259\u5c0f\u7a0b\u5e8f\u4e0eESP32",permalink:"/blog/2024/7/30/"},nextItem:{title:"\u81ea\u5236\u667a\u80fd\u5bb6\u5c45",permalink:"/blog/2024/4/30/"}},l={authorsImageUrls:[void 0]},d=[{value:"\u5b89\u88c5\u4f9d\u8d56",id:"\u5b89\u88c5\u4f9d\u8d56",level:2},{value:"\u4ee3\u7801",id:"\u4ee3\u7801",level:2},{value:"\u540e\u8bdd",id:"\u540e\u8bdd",level:2}];function m(e){const n={br:"br",code:"code",h2:"h2",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"\u5f53\u4f60\u7684\u7535\u8111\u65e0\u6cd5\u901a\u8fc7\u89c6\u9891\u7ebf\u8fde\u63a5\u5230\u7535\u89c6\u673a\uff0c\u53ef\u80fd\u662f\u7531\u4e8e\u7ebf\u7f06\u957f\u5ea6\u4e0d\u8db3\u6216\u8005\u63a5\u53e3\u4e0d\u517c\u5bb9\uff0c\u800c\u4f60\u7684\u7535\u89c6\u673a\u6070\u597d\u652f\u6301\u6d4f\u89c8\u5668\u529f\u80fd\u3002"}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"\u5f53\u4f60\u5728\u5916\u9762\u53c2\u52a0\u57f9\u8bad\u6216\u4ea4\u6d41\u6d3b\u52a8\uff0c\u73b0\u573a\u53ea\u63d0\u4f9b\u4e86\u4e00\u4e2aWiFi\u7f51\u7edc\u3002\u5927\u5bb6\u521a\u521a\u719f\u6089\uff0c\u9a6c\u4e0a\u5c31\u8981\u5f00\u59cb\u5c4f\u5e55\u5206\u4eab\uff0c\u4f60\u9700\u8981\u4e00\u4e2a\u5feb\u901f\u7684\u65b9\u5f0f\u8ba9\u5927\u5bb6\u90fd\u80fd\u770b\u5230\u4f60\u7684\u5c4f\u5e55\u3002"}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u4e2a\u65f6\u5019\uff0c\u4f60\u5c31\u9700\u8981\u4e00\u4e2a\u5de5\u5177\u6765\u6355\u83b7\u548c\u5206\u4eab\u4f60\u7684\u5c4f\u5e55\u548c\u97f3\u9891\uff08\u5305\u62ec\u8bbe\u5907\u97f3\u9891\u548c\u9ea6\u514b\u98ce\u8f93\u5165\uff09\uff0c\u5e76\u901a\u8fc7\u7f51\u9875\u5f62\u5f0f\u4e0e\u4ed6\u4eba\u5171\u4eab\u3002\u8fd9\u6837\uff0c\u89c2\u4f17\u65e0\u9700\u4e0b\u8f7d\u4efb\u4f55\u4f1a\u8bae\u8f6f\u4ef6\uff0c\u4ec5\u9700\u6253\u5f00\u6d4f\u89c8\u5668\u5373\u53ef\u89c2\u770b\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"\u5b89\u88c5\u4f9d\u8d56",children:"\u5b89\u88c5\u4f9d\u8d56"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pip install opencv-python Pillow greenlet pyaudio Flask\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u4ee3\u7801",children:"\u4ee3\u7801"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'showLineNumbers title="share.py"',children:'from flask import Flask, Response, render_template_string, stream_with_context\nimport time\nimport cv2\nfrom PIL import ImageGrab, Image\nimport threading\nfrom io import BytesIO\nfrom greenlet import getcurrent as get_ident\nimport pyaudio\n\n\nclass Audio:\n    def __init__(self):\n        self.FORMAT = pyaudio.paInt16\n        self.CHANNELS = 2\n        self.RATE = 44100\n        self.CHUNK = 1024\n        self.bitsPerSample = 16\n        self.audio = pyaudio.PyAudio()\n        self.first_run = True\n        self.wav_header = self.genHeader(self.RATE, self.bitsPerSample, self.CHANNELS)\n        self.stream = self.audio.open(\n            format=self.FORMAT,\n            channels=self.CHANNELS,\n            rate=self.RATE,\n            input=True,\n            input_device_index=1,\n            frames_per_buffer=self.CHUNK,\n        )\n        self.get_audio = self._get_audio_first_time\n\n    def genHeader(self, sampleRate, bitsPerSample, channels):\n        datasize = 2000 * 10**6\n        o = bytes("RIFF", "ascii")\n        o += (datasize + 36).to_bytes(4, "little")\n        o += bytes("WAVE", "ascii")\n        o += bytes("fmt ", "ascii")\n        o += (16).to_bytes(4, "little")\n        o += (1).to_bytes(2, "little")\n        o += (channels).to_bytes(2, "little")\n        o += (sampleRate).to_bytes(4, "little")\n        o += (sampleRate * channels * bitsPerSample // 8).to_bytes(4, "little")\n        o += (channels * bitsPerSample // 8).to_bytes(2, "little")\n        o += (bitsPerSample).to_bytes(2, "little")\n        o += bytes("data", "ascii")\n        o += (datasize).to_bytes(4, "little")\n        return o\n\n    def _get_audio_first_time(self):\n        data = self.stream.read(self.CHUNK)\n        self.get_audio = self._get_audio_subsequent_times  # switch the method\n        return self.wav_header + data\n\n    def _get_audio_subsequent_times(self):\n        return self.stream.read(self.CHUNK)\n\nclass CameraEvent(object):\n    def __init__(self):\n        self.events = {}\n\n    def wait(self):\n        ident = get_ident()\n        if ident not in self.events:\n            self.events[ident] = [threading.Event(), time.time()]\n        return self.events[ident][0].wait()\n\n    def set(self):\n        now = time.time()\n        remove = None\n        for ident, event in self.events.items():\n            if not event[0].is_set():\n                event[0].set()\n                event[1] = now\n            else:\n                if now - event[1] > 5:\n                    remove = ident\n        if remove:\n            del self.events[remove]\n\n    def clear(self):\n        self.events[get_ident()][0].clear()\n\n\nclass BaseCamera(object):\n    thread = None\n    frame = None\n    last_access = 0\n    event = CameraEvent()\n\n    def __init__(self):\n        if BaseCamera.thread is None:\n            BaseCamera.last_access = time.time()\n            BaseCamera.thread = threading.Thread(target=self._thread)\n            BaseCamera.thread.start()\n            while self.get_frame() is None:\n                time.sleep(0)\n\n    def get_frame(self):\n        BaseCamera.last_access = time.time()\n        BaseCamera.event.wait()\n        BaseCamera.event.clear()\n        return BaseCamera.frame\n\n    @staticmethod\n    def frames():\n        raise RuntimeError("Must be implemented by subclasses.")\n\n    @classmethod\n    def _thread(cls):\n        print("Starting camera thread.")\n        frames_iterator = cls.frames()\n        for frame in frames_iterator:\n            BaseCamera.frame = frame\n            BaseCamera.event.set()\n            time.sleep(0)\n            if time.time() - BaseCamera.last_access > 10:\n                frames_iterator.close()\n                print("Stopping camera thread due to inactivity.")\n                break\n        BaseCamera.thread = None\n\n\nclass Camera(BaseCamera):\n    video_source = 0\n\n    @staticmethod\n    def set_video_source(source):\n        Camera.video_source = source\n\n    @staticmethod\n    def frames():\n        camera = cv2.VideoCapture(Camera.video_source)\n        if not camera.isOpened():\n            raise RuntimeError("Error")\n        while True:\n            image = ImageGrab.grab()\n            image = image.resize((1366, 750), Image.LANCZOS)\n            output_buffer = BytesIO()\n            image.save(output_buffer, format="JPEG", quality=100)\n            frame = output_buffer.getvalue()\n            yield frame\napp = Flask(__name__)\n\ndef gen(camera):\n    while True:\n        frame = camera.get_frame()\n        yield (b"--frame\\r\\n" b"Content-Type: image/jpeg\\r\\n\\r\\n" + frame + b"\\r\\n")\n\ndef gen_audio(audio):\n    while True:\n        data = audio.get_audio()\n        yield data\n\n@app.route("/video_feed")\ndef video_feed():\n    return Response(gen(Camera()), mimetype="multipart/x-mixed-replace; boundary=frame")\n\n@app.route("/audio_feed")\ndef audio_feed():\n    return Response(stream_with_context(gen_audio(Audio())))\n\n@app.route("/")\ndef index():\n    global mode\n    video_tag = """<img src="{{ url_for(\'video_feed\') }}">"""\n    audio_tag = """<audio autoplay style="display:none;"><source src="{{ url_for(\'audio_feed\') }}" type="audio/x-wav; codec=pcm">Your browser does not support the audio element.</audio>"""\n\n    tags = {0: video_tag + audio_tag, 1: audio_tag, 2: video_tag}\n\n    content = tags[mode]\n\n    return render_template_string(\n        """<html>\n    <head>\n        <title>{title}</title>\n        <link rel="icon" href="data:image/svg+xml;base64,CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgNTAgNTAiPgogICAgPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiIGZpbGw9InJlZCIgLz4KPC9zdmc+Cg==">\n    </head>\n    <body>{content}</body>\n    </html>""".format(\n            title=["Intranet Broadcast", "Audio Sharing", "Screen Sharing"][mode],\n            content=content,\n        )\n    )\n\nif __name__ == "__main__":\n    local_host = "127.0.0.1"\n    ip_host = "0.0.0.0"\n    port = 8001\n    mode = int(input("Please select the mode: 0 for Intranet Broadcast, 1 for Audio Sharing, 2 for Screen Sharing: "))\n    app.run(threaded=True, host=ip_host, port=port)\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u8fd0\u884c\u7a0b\u5e8f\u540e\uff0c\u7a0b\u5e8f\u4f1a\u63d0\u793a\u4f60\u8f93\u5165\u4e00\u4e2a\u6570\u5b57\uff1a"}),"\n",(0,a.jsxs)(n.p,{children:["0\u8868\u793a\u540c\u65f6\u5206\u4eab\u5c4f\u5e55\u548c\u97f3\u9891",(0,a.jsx)(n.br,{}),"\n","1\u8868\u793a\u4ec5\u5206\u4eab\u97f3\u9891",(0,a.jsx)(n.br,{}),"\n","2\u8868\u793a\u4ec5\u5206\u4eab\u5c4f\u5e55"]}),"\n",(0,a.jsx)(n.p,{children:"\u8f93\u5165\u76f8\u5e94\u6570\u5b57\u540e\u6309\u56de\u8f66\u952e\u5373\u53ef\u3002\u7a0b\u5e8f\u8fd0\u884c\u540e\uff0c\u4f1a\u5728\u63a7\u5236\u53f0\u8f93\u51fa\u4e00\u4e2aURL\u3002\u4f60\u53ea\u9700\u5728\u6d4f\u89c8\u5668\u4e2d\u8f93\u5165\u8fd9\u4e2aURL\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u4f60\u7684\u5c4f\u5e55\u548c\u97f3\u9891\u4e86\u3002"}),"\n",(0,a.jsx)(n.h2,{id:"\u540e\u8bdd",children:"\u540e\u8bdd"}),"\n",(0,a.jsx)(n.p,{children:"\u4f60\u53ef\u4ee5\u5728\u6b64\u9879\u76ee\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u6269\u5c55\uff0c\u589e\u52a0\u66f4\u591a\u529f\u80fd\uff0c\u5982\uff1a"}),"\n",(0,a.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","\u8bc6\u522b\u5f53\u524d\u97f3\u9891\u5e76\u5c06\u5176\u8f6c\u5316\u4e3a\u6587\u672c\uff0c\u4e0e\u5c4f\u5e55\u5171\u4eab\u4e00\u8d77\u4f20\u8f93\uff0c\u8fd9\u6837\u89c2\u4f17\u5c31\u53ef\u4ee5\u5728\u5c4f\u5e55\u4e0a\u770b\u5230\u4f60\u7684\u8bb2\u8bdd\u5185\u5bb9\u3002"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","\u7ed3\u5408\u7ffb\u8bd1API\uff0c\u5b9e\u73b0\u5b9e\u65f6\u7ffb\u8bd1\u529f\u80fd\u3002"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",checked:!0,disabled:!0})," ","\u538b\u7f29\u5c4f\u5e55\u753b\u9762\u8d28\u91cf\uff0c\u83b7\u5f97\u66f4\u6d41\u7545\u7684\u4f20\u8f93\u6548\u679c\u7b49\u7b49\u3002"]}),"\n"]})]})}function c(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(m,{...e})}):m(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var a=t(96540);const s={},i=a.createContext(s);function r(e){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);