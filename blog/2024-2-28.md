---
slug: /oldremove
title: 旧服务的迁移
date: 2024-2-28
authors: jiangmiemie
tags: [remove, tutorial]
keywords: [remove, tutorial]
description: 记录自己是对公司旧服务迁移的
---

## 背景

一段时间以前，我们的公司为了完成一个招投标项目，与一家第三方公司合作开发了一个网站。这个项目采取了全包模式：服务器、技术栈、域名等所有事宜都由第三方公司负责，我们只需提供内容即可。然而，现在这个网站的服务器租期即将到期。考虑到维持现状的成本较高，且丢弃已有的网站又显得浪费，我们决定以较低的成本将其托管到公司自己的服务器上。

## 原环境的分析

网站使用了前后端分离的设计模式，前端是基于Vue生成的静态页面。后端则是基于Java，允许上传一些文件，使用的是3000端口进行通信，文件传输则是在8000端口，路径设置为/upload/。通过Nginx进行了反向代理，将/upload/路径的请求转发到8080端口，将其他请求（80端口）转发到3000端口。因此，对于这个网站，通信主要通过80端口和8080端口进行。

:::tip
如果你遇到了类似的问题，只需要梳理出我们最终通过宝塔面板的哪些端口访问就可以了。
:::

租用的服务器是阿里云的产品，并选择了宝塔面板进行管理。

域名是从一家小型第三方公司购买的，该公司仅提供域名解析服务。

## 迁移策略

### 服务器迁移

由于我对Java并不熟悉，且这种服务一旦部署就很少需要修改，我决定为其创建一个独立的容器，并按照原来的交接文档在容器内部重新运行服务。这就需要创建一个宝塔面板的Docker，并将所有服务原样迁移过去。相关的命令设置为开机自启动。另外，重要的文件等资料需要单独挂载，并可以设置为只读模式，以防止数据丢失同时更加安全。

### 端口映射

Docker的镜像可以通过端口映射的方式，将容器内的端口映射到宿主机（群晖）的端口上。

华为路由器可以将外网流量转发到宿主机（群晖）上，因此只需要在路由器上设置端口转发即可。

:::tip
需要注意的是，群晖的部分端口可能已被群晖自身使用，可以通过群晖官网[查询](https://kb.synology.cn/zh-cn/DSM/tutorial/What_network_ports_are_used_by_Synology_services)。外网的部分端口（譬如80端口）可能被运营商封掉，或者华为路由器自身需要使用。因此，我们需要选择一些不常用的端口，以避免出现服务异常。
:::

因此有了以下的端口映射规则（你可以先停止容器再设置）：

| 容器内端口（宝塔） | 宿主机端口（群晖） | 外网端口 |
| --- | --- | --- |
| 80  | 4080 | 4080 |
| 8080 | 8080 | 4880 |

### 域名解析

由于我们的服务器之前主要用于内部服务，通过IP地址访问并无大碍。但现在我们需要将域名解析到公司的服务器上，由于80端口不能直接访问，并且园区和域名供应商都会要求备案，这就需要我们使用Cloudflare的DNS解析服务。Cloudflare可以充当中间人，将流量转发到公司的服务器上。

> 即无法通过 http://www.xxx.com 直接访问到公司的服务器，只能通过域名+端口号如 http://www.xxx.com:8080 访问。

在cloudflare中添加域名，全程按照提示操作添加即可。

添加完成后，选择规则->回源（Origin Rules）,因为Java用到了2个端口，所以需要添加两个端口转发规则：

- 当满足条件时（访问域名且路径不以/upload/开头），将流量转发到公司服务器的4080端口。

- 当满足条件时（访问域名且路径以/upload/开头），将流量转发到公司服务器的4880端口。

## 结果

通过以上步骤，我们成功地将网站迁移到了公司的服务器上。用户访问网站时，流程如下：

- 通过DNS解析，找到cloudflare的服务器。
- cloudflare根据规则，把80流量转发到路由器的4080上。
- 公司服务器接收到流量，把流量转发到群晖的4080端口。
- 群晖接收到流量，把流量转发到容器的80端口。
- 容器接收到流量，通过Nginx分配数据。
- Nginx根据规则，把流量转发到容器内的8080端口。
- 数据按照原本的路径逐一返回至cloudflare。
- cloudflare把数据返回给访问者。

这种迁移方式不仅保证了原有服务的连续性，也确保了公司服务器不会被外网直接访问，从而提高了公司的网络安全性。即使网站被黑，也不会影响到公司的其他服务，只需重启这个容器即可恢复原状。

## 后话

这次的迁移过程体现了分层思想的重要性，这主要来自《白帽子讲Web安全》这本书。整个过程没有遇到什么问题，只需要对容器化和Cloudflare有一定的了解。我希望我的经验能给读者带来一些启示。